# AI Bot 重构与功能实现计划

目标：在 Tailchat 现有机制限制下，实现可用的“图片发送”和“流式输出”体验，并给出更完善的 Markdown 支持改造方案。

## 1. 范围与约束确认

- 机器人类型：OpenAPI Bot vs Plugin Bot
- 限制点：上传/存储、消息结构、前端渲染、权限与鉴权、API 是否支持增量更新
- 输出目标：
  - 可发送图片（至少支持 URL 形式；如能走上传则完善）
  - 流式输出（最小可用体验）

## 2. 图片发送（两条路径）

### 2.1 URL 图片
- 发送消息时使用 Markdown 图片语法或自定义 meta 渲染
- 依赖前端 Markdown 渲染层允许 `img` 标签/语法
- 可在 `meta` 内携带 `image` 字段，前端做兼容渲染

### 2.2 上传图片
- 服务端检查 `file` 相关接口能力与限制
- 走上传 -> 拿到静态 URL -> 发送 URL 图片消息
- 若存在上传限制（大小/类型/鉴权）
  - 在 bot 侧裁剪/压缩
  - fallback 到链接

## 3. 流式输出（三种策略）

### 3.1 消息增量更新（最佳体验）
- 需要服务端/客户端支持“修改消息内容”API
- 方案：发送占位消息 -> 按 token 增量更新
- 如果没有 `chat.message.update` 类似接口，需新增

### 3.2 多条消息节流（无需后端改动）
- 每 N 个 token 发送一条消息
- 体验次优但可实现

### 3.3 伪流式（打字效果）
- 前端使用 SSE/WebSocket 接收流式响应
- UI 侧渲染为逐字显示
- Bot 只负责一次性返回完整消息

## 4. Bot 结构与接口设计

- 接口：
  - `POST /callback`（接收 Tailchat 消息回调）
  - `POST /respond`（内部调 OpenAI）
  - `POST /send`（封装 Tailchat 发送）
- 鉴权：
  - 校验请求来源、签名或 token
  - Bot token 定期刷新

## 5. MVP 交付标准

- 文字消息可回复（现有完成）
- 图片发送可用（URL）
- 流式输出有可感知体验（多条消息 or 伪流式）

## 6. 风险与依赖

- 若没有消息更新 API，真正流式需要改后端服务
- 图片上传受限于存储配置与文件大小
- Markdown 渲染安全策略可能限制 `img` / `iframe`