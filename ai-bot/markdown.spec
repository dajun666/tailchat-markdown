# Markdown 增强支持计划

目标：在不影响现有消息渲染与安全策略的前提下，增强 Markdown 能力，并支持“粘贴图片 → 本地预览 → 发送时上传 → 正常渲染”。

## 1. 现状梳理
- 现有 Markdown 渲染组件与配置位置
- 允许的语法与标签清单
- 已有插件或扩展点（如自定义语法、渲染钩子）

## 2. 功能增强

### 2.1 Markdown 语法增强
- 表格、任务列表、脚注
- 代码高亮（语言识别）
- Mermaid/PlantUML（可选）
- 数学公式（KaTeX/MathJax，可选）

### 2.2 粘贴图片（本地预览 → 发送时上传）
- 输入框监听 `paste` 事件，识别剪贴板中的图片 Blob
- 生成本地预览（`URL.createObjectURL`），在输入区域内渲染 `img` 预览标签
- 未发送前仅保存在本地状态（pending attachments）
- 用户按 Enter/发送按钮时才上传图片并提交消息
- 发送后将本地预览替换为远端可访问的 URL（消息中使用 `img` 标签或 markdown 图片语法）
- 失败回滚：上传失败时保留本地预览并提示重试/删除
- 约束：大小上限、类型白名单（png/jpg/gif/webp）、数量限制

### 2.3 安全与白名单
- 限制 `img`/`iframe`/`video` 的来源（白名单或代理）
- 对外链进行严格过滤与转义

### 2.4 扩展语法（可选）
- 自定义标签：如 `@bot`、`@file`
- 链接预览与富卡片

## 3. 技术路线
- 前端：扩展编辑器与渲染链路（paste 处理、附件队列、本地预览）
- 后端：上传接口/鉴权/存储策略（如已有上传能力则复用）
- 插件：若不改核心，可做渲染插件与编辑器插件

## 4. 交付标准
- 粘贴图片在本地可见且不自动发送
- 按 Enter 后才上传并发送，接收方能正常渲染
- Markdown 增强功能稳定可用
- 安全策略清晰并有默认限制
